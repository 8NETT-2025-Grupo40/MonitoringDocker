services:
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - ./influxdb/init:/docker-entrypoint-initdb.d
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: admin123
      DOCKER_INFLUXDB_INIT_ORG: agro-org
      DOCKER_INFLUXDB_INIT_BUCKET: sensores
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: influx-token

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana:10.2.3
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      # ===== SERVER =====
      GF_SERVER_ROOT_URL: ${GRAFANA_URL:-http://localhost:3000}/
      GF_SERVER_COOKIE_SECURE: "${GRAFANA_COOKIE_SECURE:-false}"
      GF_SERVER_COOKIE_SAMESITE: ${GRAFANA_COOKIE_SAMESITE:-lax}
      GF_SECURITY_COOKIE_SAMESITE: ${GRAFANA_SECURITY_COOKIE_SAMESITE:-lax}

      # ===== SECURITY (break-glass admin) =====
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin123}

      # ===== GENERIC OAUTH - AWS COGNITO =====
      GF_AUTH_GENERIC_OAUTH_ENABLED: "${GRAFANA_OAUTH_ENABLED:-false}"
      GF_AUTH_GENERIC_OAUTH_NAME: ${GRAFANA_OAUTH_NAME:-Cognito}
      GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP: "${GRAFANA_OAUTH_ALLOW_SIGN_UP:-true}"

      # Credentials
      GF_AUTH_GENERIC_OAUTH_CLIENT_ID: ${CLIENT_ID:-}
      GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET: ${CLIENT_SECRET:-}

      # OAuth Scopes
      GF_AUTH_GENERIC_OAUTH_SCOPES: ${COGNITO_SCOPES:-openid email phone}

      # Cognito Endpoints
      GF_AUTH_GENERIC_OAUTH_AUTH_URL: ${COGNITO_DOMAIN:-https://us-east-26eo2tdlnq.auth.us-east-2.amazoncognito.com}/oauth2/authorize
      GF_AUTH_GENERIC_OAUTH_TOKEN_URL: ${COGNITO_DOMAIN:-https://us-east-26eo2tdlnq.auth.us-east-2.amazoncognito.com}/oauth2/token
      GF_AUTH_GENERIC_OAUTH_API_URL: ${COGNITO_DOMAIN:-https://us-east-26eo2tdlnq.auth.us-east-2.amazoncognito.com}/oauth2/userInfo

      # Email (obrigat√≥rio para signup no Grafana)
      GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH: email

      # Logout federado (Generic OAuth usa signout_redirect_url)
      GF_AUTH_GENERIC_OAUTH_SIGNOUT_REDIRECT_URL: ${COGNITO_DOMAIN:-https://us-east-26eo2tdlnq.auth.us-east-2.amazoncognito.com}/logout?client_id=${CLIENT_ID:-}&logout_uri=${GRAFANA_URL:-http://localhost:3000}/

      # Use PKCE (more secure for public clients like SPAs)
      GF_AUTH_GENERIC_OAUTH_USE_PKCE: "${GRAFANA_OAUTH_USE_PKCE:-true}"

      # ===== LOGGING =====
      GF_LOG_LEVEL: ${GRAFANA_LOG_LEVEL:-info}

    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - influxdb
      - prometheus

volumes:
  influxdb-data:
  grafana-data:
